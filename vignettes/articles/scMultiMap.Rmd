---
title: "scMultiMap"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette shows an example of applying `scMultiMap` to infer peak-gene associations in cell types with single-cell multimodal data.

# 1. Load packages and data
```{r setup, warning = FALSE, message = FALSE}
library(scMultiMap)
library(Signac)
library(Seurat)
```

In this vignette, we use the single cell multiome data (paired scRNA-seq and scATAC-seq) from 10x. The data `processed_seurat_obj_PBMC_10k.rds` can be generated by following these two Signac tutorials: [Joint RNA and ATAC analysis: 10x multiomic](https://stuartlab.org/signac/articles/pbmc_multiomic.html) and [Calling peaks](https://stuartlab.org/signac/articles/peak_calling). The first tutorial is for annotating PBMC cell types, and the second tutorial is for calling peaks by cell type to identify as many cell-type-specific peaks as possible. 

We note that scMultiMap is designed to model **fragment counts**, which are more appropriate for count based modeling and can yield improved performance in downstream analysis compared to read counts. See [Miao and Kim, 2024](https://www.nature.com/articles/s41592-023-02103-7) and [Martens et al., 2024](https://www.nature.com/articles/s41592-023-02112-6) for more discussions. If you plan to use scMultiMap, please make sure the your scATAC-seq data are fragment counts instead of read counts. One recommended way is to use MACS2 to call peaks which generates fragment counts, as shown in [Calling peaks](https://stuartlab.org/signac/articles/peak_calling). If you only have read counts, fragment counts can be estimated following [Martens et al., 2024](https://www.nature.com/articles/s41592-023-02112-6).

Back to this case study. We load the 10x multiome data on PBMC into the R session:
```{r include = FALSE}
pbmc <- readRDS('../../../example_data/processed_seurat_obj_PBMC_10k.rds')
```

```{r eval = FALSE}
pbmc <- readRDS('processed_seurat_obj_PBMC_10k.rds')
```

# 2. Select the cell types and peak-gene pairs to study

In this example, we focus on CD14 monocytes, study top $2{,}000$ highly expressed genes and top $20{,}000$ highly accessible peaks, and use a cis-region of width 1Mb to define candidate enhancer-gene pairs.

```{r}
pbmc_cd14 <- subset(pbmc, predicted.id == 'CD14 Mono')
```

```{r include=FALSE}
peak_gene_pairs <- read.table('../../../example_data/CD14 Mono_20000_peak_2000_gene_pairs.txt', header=T)
```

```{r eval=FALSE}
# pairs of top 2000 highly expressed genes and top 20000 highly accessible peaks
# where the peak overlap with the 1Mb region around the TSS region of the gene
# generally, these pairs should be provided by the users
peak_gene_pairs <- read.table('CD14 Mono_20000_peak_2000_gene_pairs.txt', header=T)
```

```{r}
head(peak_gene_pairs) # only the first two column are necessary for running scMultiMap

nrow(peak_gene_pairs) # number of peak-gene pairs to evaluate
```


# 3. Run `scMultiMap` to identify significantly associated peak-gene pairs

```{r}
start <- Sys.time()
res <- scMultiMap(pbmc_cd14, peak_gene_pairs[,c('gene','peak')], 
                  gene_assay = 'RNA',
                  peak_assay = 'peaks_ct')
end <- Sys.time() 
end - start
```

```{r}
# all supplied peak-gene pairs evaluated
nrow(res)

# peak-gene association inference results
head(res)
```
